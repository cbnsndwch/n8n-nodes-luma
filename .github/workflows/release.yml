name: Release to npm

on:
  push:
    tags: ['v*.*.*']

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pnpm install || { echo "âŒ Dependency installation failed"; exit 1; }
          echo "âœ… Dependencies installed successfully"
        
      - name: Validate package with dry-run
        run: |
          echo "ğŸ” Validating package structure with dry-run..."
          npm pack --dry-run || { echo "âŒ Package validation failed"; exit 1; }
          echo "âœ… Package structure validated successfully"
        
      - name: Run comprehensive validation
        run: |
          echo "ğŸ” Running comprehensive pre-publish validation..."
          pnpm run prepublishOnly || { echo "âŒ Pre-publish validation failed"; exit 1; }
          echo "âœ… Pre-publish validation completed successfully"
        
      - name: Run tests
        run: |
          echo "ğŸ§ª Running test suite..."
          pnpm run test || { echo "âŒ Test suite failed"; exit 1; }
          echo "âœ… All tests passed successfully"
        
      - name: Validate package contents
        run: |
          echo "ğŸ” Validating final package contents..."
          # Check that dist/ directory exists and contains required files
          test -d dist || { echo "âŒ Missing dist/ directory"; exit 1; }
          test -f dist/package.json || { echo "âŒ Missing dist/package.json"; exit 1; }
          test -f dist/nodes/Luma/Luma.node.js || { echo "âŒ Missing main node file"; exit 1; }
          test -f dist/credentials/LumaApi.credentials.js || { echo "âŒ Missing credentials file"; exit 1; }
          
          # Verify package.json has correct name and version
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“‹ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "âœ… Package contents validated successfully"
        
      - name: Publish to npm
        run: |
          echo "ğŸš€ Publishing package to npm..."
          pnpm publish --access public || { echo "âŒ npm publish failed"; exit 1; }
          echo "âœ… Package published successfully to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Verify publication
        run: |
          echo "ğŸ” Verifying package publication..."
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          # Wait a moment for npm registry to update
          sleep 10
          
          # Check if package is available on npm
          npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version || { echo "âš ï¸ Package not yet available on npm registry (may take a few minutes)"; exit 0; }
          echo "âœ… Package successfully published and available on npm registry"